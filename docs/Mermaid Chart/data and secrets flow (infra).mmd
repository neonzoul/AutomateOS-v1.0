flowchart LR
  %% Classes
  classDef svc fill:#f5f5f5,stroke:#888,stroke-width:1.5
  classDef data fill:#fff,stroke:#555,stroke-dasharray:4 2
  classDef sec fill:#fff,stroke:#7A1E1E,stroke-width:1.5,stroke-dasharray:3 3

  %% Services
  subgraph Backend Services - Node TS
    APIGW["API Gateway"]:::svc
    WEBH["Webhook"]:::svc
    ORCH["Orchestrator"]:::svc
    WORK["Worker"]:::svc
  end

  %% Data
  subgraph Data Plane
    DB["Postgres<br/><i>Workflows, runs</i>"]:::data
    Q["Redis / Queue<br/><i>Job scheduling</i>"]:::data
    LOGS["Run Logs<br/><i>Append-only</i>"]:::data
  end

  %% Secrets
  subgraph Secrets & Config
    VAULT["Secret Manager / Env<br/><i>AES-GCM at rest</i>"]:::sec
  end

  %% Data paths
  APIGW --> DB
  WORK  --> DB
  ORCH --> Q
  WEBH --> Q
  WORK  --> Q
  WORK  --> LOGS

  %% Secrets reads (dotted red)
  APIGW -.-> VAULT
  ORCH -.-> VAULT
  WORK  -.-> VAULT

  %% Link coloring
  linkStyle 0,1,2,3,4,5 stroke:#555,stroke-width:1.5px   %% Data accesses
  linkStyle 6,7,8 stroke:#b91c1c,stroke-dasharray:3 3    %% Secrets

  %% Legend
  subgraph Legend
    L1["⬛ Gray = data plane access"]
    L2["⬛ Dashed Red = secrets read"]
  end
  class Legend svc
